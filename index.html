<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Relatório de Spools por Status</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:12px;background:#f7f7f7}
    h2{margin:0 0 10px 0}
    .container{max-width:1200px;margin:auto;background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    button,input,select{padding:10px;font-size:14px}
    input{flex:1;min-width:220px}
    button{cursor:pointer;background:#1976d2;color:#fff;border:none;border-radius:4px}
    select{border:1px solid #ddd;border-radius:4px;background:#fff}
    .muted{font-size:12px;color:#555;width:100%}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:980px){ .grid{grid-template-columns:1.2fr .8fr} }
    .card{border:1px solid #eee;border-radius:8px;padding:10px;background:#fff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;font-size:12px}
    table{border-collapse:collapse;width:100%;min-width:900px}
    th,td{border:1px solid #ddd;padding:8px;white-space:nowrap}
    th{background:#f1f1f1;position:sticky;top:0}
  </style>
</head>
<body>

<div class="container">
<h2>Relatório de Spools por Status</h2>

<div class="top">
  <button id="btn">Atualizar</button>
  <input id="filtro" placeholder="Filtrar texto">
  <select id="fRomaneio">
    <option value="TODOS">Romaneio: Todos</option>
    <option value="COM">Romaneio: Com</option>
    <option value="SEM">Romaneio: Sem</option>
  </select>
  <select id="fProg">
    <option value="TODOS">Programação: Todos</option>
    <option value="COM">Programação: Com</option>
    <option value="SEM">Programação: Sem</option>
  </select>
  <button id="btnExport">Exportar Excel</button>
  <button id="btnPizza">Pizza: Peso</button>
  <div class="muted" id="status">Carregando...</div>
</div>

<div class="grid">
  <div class="card">
    <span class="pill" id="pillLinhas">0 linhas</span>
    <table>
      <thead>
        <tr>
          <th>Serviço</th><th>Local</th><th>Material</th>
          <th>Prog Fab</th><th>Status</th><th>Qtd</th><th>Peso</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <div class="card">
    <span class="pill" id="pillStatus">0 status</span>
    <canvas id="pizza" height="280"></canvas>
  </div>
</div>
</div>

<script>
const SHEET_ID = "1mMobUTfuUuZ5fDj-CANPGxX3EL-7LgQZ1JzQZwVluB0";
const URL = `https://opensheet.elk.sh/${SHEET_ID}/DADOS`;

let cache=[], ultimoFiltrado=[], pizzaChart=null, pizzaModo="PESO";

function valorPreenchido(v){
  let s=String(v??"").replace(/\u00A0/g," ").trim();
  if(!s) return false;
  const u=s.toUpperCase();
  return !(u==="N/A"||u==="NA"||u==="-"||u==="—");
}
function toNum(v){return Number(String(v||0).replace(/\./g,"").replace(",","."))||0}
function fmt(n){return n.toLocaleString("pt-BR",{minimumFractionDigits:2})}

function render(lista){
  const tb=document.getElementById("tb"); tb.innerHTML="";
  let tot=0;
  lista.forEach(r=>{
    const q=Number(r["QTD SPOOLS"]||0);
    const p=toNum(r["PESO TOTAL"]);
    tot+=p;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r["SERVIÇO"]||""}</td><td>${r["LOCAL FABRICAÇÃO"]||""}</td>
      <td>${r["MATERIAL"]||""}</td><td>${r["PROG FAB"]||""}</td>
      <td>${r["STATUS"]||""}</td><td>${q}</td><td>${fmt(p)}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById("pillLinhas").textContent=lista.length+" linhas";
  atualizarPizza(lista);
}

function aplicarFiltro(){
  const txt=document.getElementById("filtro").value.toUpperCase();
  const fRom=document.getElementById("fRomaneio").value;
  const fProg=document.getElementById("fProg").value;

  let f=cache.filter(r=>{
    if(txt){
      const s=[r["SERVIÇO"],r["LOCAL FABRICAÇÃO"],r["MATERIAL"],r["STATUS"]].join(" ").toUpperCase();
      if(!s.includes(txt)) return false;
    }
    const temRom=valorPreenchido(r["STATUS"]);
    if(fRom==="COM"&&!temRom) return false;
    if(fRom==="SEM"&&temRom) return false;

    const temProg=valorPreenchido(r["PROG FAB"]);
    if(fProg==="COM"&&!temProg) return false;
    if(fProg==="SEM"&&temProg) return false;

    return true;
  });
  ultimoFiltrado=f;
  render(f);
}

function atualizarPizza(lista){
  const m={};
  lista.forEach(r=>{
    const st=r["STATUS"]||"SEM STATUS";
    m[st]=(m[st]||0)+(pizzaModo==="PESO"?toNum(r["PESO TOTAL"]):Number(r["QTD SPOOLS"]||0));
  });
  const labels=Object.keys(m), data=Object.values(m);
  if(pizzaChart) pizzaChart.destroy();
  pizzaChart=new Chart(document.getElementById("pizza"),{
    type:"pie",
    data:{labels,datasets:[{data}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

async function carregar(){
  const r=await fetch(URL);
  cache=await r.json();
  aplicarFiltro();
  document.getElementById("status").textContent="Atualizado "+new Date().toLocaleString("pt-BR");
}

document.getElementById("btn").onclick=carregar;
document.getElementById("filtro").oninput=aplicarFiltro;
document.getElementById("fRomaneio").onchange=aplicarFiltro;
document.getElementById("fProg").onchange=aplicarFiltro;
document.getElementById("btnPizza").onclick=()=>{pizzaModo=pizzaModo==="PESO"?"QTD":"PESO";aplicarFiltro()};
document.getElementById("btnExport").onclick=()=>{
  if(!ultimoFiltrado.length)return alert("Nada para exportar");
  const ws=XLSX.utils.json_to_sheet(ultimoFiltrado);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"FILTRADO");
  XLSX.writeFile(wb,"relatorio_filtrado.xlsx");
};

carregar();
</script>
</body>
</html>
