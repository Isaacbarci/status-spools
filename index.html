<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Relatório de Spools + % por Status</title>

  <!-- Exportar Excel (filtrado) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Gráfico Pizza por Status -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family:Arial,Helvetica,sans-serif;
      margin:0;
      padding:12px;
      background:#f7f7f7;
    }
    h2{margin:0 0 10px 0}
    .container{
      max-width:1200px;
      margin:auto;
      background:#fff;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
    }
    .top{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    button,input,select{
      padding:10px;
      font-size:14px;
    }
    input{
      flex:1;
      min-width:220px;
    }
    button{
      cursor:pointer;
      background:#1976d2;
      color:#fff;
      border:none;
      border-radius:4px;
    }
    button:hover{opacity:.9}
    select{
      border:1px solid #ddd;
      border-radius:4px;
      background:#fff;
    }
    .muted{
      font-size:12px;
      color:#555;
      width:100%;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1.2fr .8fr; }
    }
    .card{
      border:1px solid #eee;
      border-radius:8px;
      padding:10px;
      background:#fff;
      box-shadow:0 1px 4px rgba(0,0,0,.04);
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#eee;
      font-size:12px;
    }
    .table-wrapper{
      width:100%;
      overflow-x:auto;
      margin-top:8px;
    }
    table{
      border-collapse:collapse;
      width:100%;
      min-width:900px;
    }
    th,td{
      border:1px solid #ddd;
      padding:8px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      background:#f1f1f1;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody tr:nth-child(even){ background:#fafafa; }
    tfoot th{ background:#e9e9e9; }

    @media (max-width:600px){
      h2{font-size:18px}
      button,input,select{width:100%}
      table{font-size:13px}
    }
  </style>
</head>

<body>
<div class="container">

  <h2>Relatório de Spools + % por Status</h2>

  <div class="top">
    <button id="btn">Atualizar</button>

    <input id="filtro" placeholder="Filtrar (ex: NOVUS ANDRADINA LIBERADO)">

    <select id="fRomaneio" title="Romaneio = STATUS preenchido/vazio">
      <option value="TODOS">Romaneio: Todos</option>
      <option value="COM">Romaneio: Com</option>
      <option value="SEM">Romaneio: Sem</option>
    </select>

    <select id="fProg" title="Programação = PROG FAB preenchido/vazio">
      <option value="TODOS">Programação: Todos</option>
      <option value="COM">Programação: Com</option>
      <option value="SEM">Programação: Sem</option>
    </select>

    <button id="btnExport">Exportar Excel (filtrado)</button>
    <button id="btnPizza">Pizza: Peso</button>

    <div class="muted" id="status">Carregando...</div>
  </div>

  <div class="grid">

    <!-- Detalhado -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px">
        <strong>Detalhado</strong>
        <span class="pill" id="pillLinhas">0 linhas</span>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Serviço</th>
              <th>Local</th>
              <th>Material</th>
              <th>Prog Fab</th>
              <th>Status</th>
              <th>Qtd</th>
              <th>Peso</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
          <tfoot>
            <tr>
              <th colspan="5">TOTAL (filtrado)</th>
              <th id="tq">0</th>
              <th id="tp">0,00</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Resumo + Pizza -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px">
        <strong>Resumo por Status</strong>
        <span class="pill" id="pillStatus">0 status</span>
        <span class="pill" id="pizzaInfo">Modo: Peso</span>
      </div>

      <div class="table-wrapper">
        <table style="min-width:650px">
          <thead>
            <tr>
              <th>Status</th>
              <th>Qtd</th>
              <th>% Qtd</th>
              <th>Peso</th>
              <th>% Peso</th>
            </tr>
          </thead>
          <tbody id="tbStatus"></tbody>
          <tfoot>
            <tr>
              <th>TOTAL</th>
              <th id="tq2">0</th>
              <th>100%</th>
              <th id="tp2">0,00</th>
              <th>100%</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:12px">
        <canvas id="pizza" height="260"></canvas>
      </div>
    </div>

  </div>
</div>

<script>
  // ====== GOOGLE SHEETS (SEU LINK) ======
  const SHEET_ID = "1mMobUTfuUuZ5fDj-CANPGxX3EL-7LgQZ1JzQZwVluB0";
  const ABA = "DADOS";
  const URL = `https://opensheet.elk.sh/${SHEET_ID}/${ABA}`;
  // =====================================

  let cache = [];
  let timerFiltro = null;

  let ultimoFiltrado = [];
  let pizzaChart = null;
  let pizzaModo = "PESO"; // "PESO" ou "QTD"

  function setStatus(msg){ document.getElementById("status").textContent = msg; }

  function toNumberPtBR(v){
    if (v == null) return 0;
    if (typeof v === "number") return Number.isFinite(v) ? v : 0;
    const s = String(v).trim();
    if (!s) return 0;
    const norm = s.replace(/\./g,"").replace(",",".");
    const n = Number(norm);
    return Number.isFinite(n) ? n : 0;
  }

  function toIntSafe(v){
    return Math.round(toNumberPtBR(v));
  }

  function fmtPeso(n){
    return (n ?? 0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
  }

  function fmtPct(x){
    const v = (x ?? 0) * 100;
    return v.toLocaleString("pt-BR",{maximumFractionDigits:2}) + "%";
  }

  // Regra: preenchida ou vazia
  function colunaPreenchida(row, col){
    return (row[col] ?? "").toString().trim() !== "";
  }

  function buildRowSafe(tbody, cells){
    const tr = document.createElement("tr");
    for (const c of cells){
      const td = document.createElement("td");
      td.textContent = c ?? "";
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  function renderDetalhado(lista){
    const tb = document.getElementById("tb");
    tb.innerHTML = "";

    let totalQtd = 0;
    let totalPeso = 0;

    for(const row of lista){
      if ((row["SERVIÇO"] || "").toUpperCase() === "TOTAL GERAL") continue;

      const qtd = toIntSafe(row["QTD SPOOLS"]);
      const peso = toNumberPtBR(row["PESO TOTAL"]);

      totalQtd += qtd;
      totalPeso += peso;

      buildRowSafe(tb, [
        row["SERVIÇO"] ?? "",
        row["LOCAL FABRICAÇÃO"] ?? "",
        row["MATERIAL"] ?? "",
        row["PROG FAB"] ?? "",
        row["STATUS"] ?? "",
        String(qtd),
        fmtPeso(peso)
      ]);
    }

    document.getElementById("tq").textContent = totalQtd;
    document.getElementById("tp").textContent = fmtPeso(totalPeso);
    document.getElementById("pillLinhas").textContent = lista.length + " linhas";
    return { totalQtd, totalPeso };
  }

  function agruparPorStatus(lista){
    const mapa = new Map();
    for (const row of lista){
      const st = (row["STATUS"] ?? "").toString().trim() || "SEM STATUS";
      const qtd = toIntSafe(row["QTD SPOOLS"]);
      const peso = toNumberPtBR(row["PESO TOTAL"]);

      const cur = mapa.get(st) || { qtd:0, peso:0 };
      cur.qtd += qtd;
      cur.peso += peso;
      mapa.set(st, cur);
    }
    return [...mapa.entries()].sort((a,b) => b[1].peso - a[1].peso);
  }

  function renderResumoStatus(lista, totalQtd, totalPeso){
    const tb = document.getElementById("tbStatus");
    tb.innerHTML = "";

    const itens = agruparPorStatus(lista);

    for (const [st, v] of itens){
      const pctQtd = totalQtd > 0 ? (v.qtd / totalQtd) : 0;
      const pctPeso = totalPeso > 0 ? (v.peso / totalPeso) : 0;

      buildRowSafe(tb, [
        st,
        String(v.qtd),
        fmtPct(pctQtd),
        fmtPeso(v.peso),
        fmtPct(pctPeso)
      ]);
    }

    document.getElementById("tq2").textContent = totalQtd;
    document.getElementById("tp2").textContent = fmtPeso(totalPeso);
    document.getElementById("pillStatus").textContent = itens.length + " status";
  }

  function atualizarPizza(lista){
    const itens = agruparPorStatus(lista);

    const labels = itens.map(([st]) => st);
    const values = itens.map(([,v]) => pizzaModo === "PESO" ? v.peso : v.qtd);

    const info = document.getElementById("pizzaInfo");
    info.textContent = "Modo: " + (pizzaModo === "PESO" ? "Peso" : "Qtd");

    const canvas = document.getElementById("pizza");
    if (!canvas) return;

    if (pizzaChart) pizzaChart.destroy();

    pizzaChart = new Chart(canvas, {
      type: "pie",
      data: {
        labels,
        datasets: [{ data: values }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: (tt) => {
                const label = tt.label ?? "";
                const v = tt.raw ?? 0;
                return pizzaModo === "PESO"
                  ? `${label}: ${fmtPeso(v)}`
                  : `${label}: ${v}`;
              }
            }
          }
        }
      }
    });
  }

  function exportarExcelFiltrado(){
    if (!ultimoFiltrado || ultimoFiltrado.length === 0){
      alert("Nada filtrado para exportar.");
      return;
    }

    const colunas = [
      "SERVIÇO",
      "LOCAL FABRICAÇÃO",
      "MATERIAL",
      "PROG FAB",
      "STATUS",
      "QTD SPOOLS",
      "PESO TOTAL"
    ];

    const dados = ultimoFiltrado.map(r => {
      const o = {};
      for (const c of colunas) o[c] = r[c] ?? "";
      return o;
    });

    const ws = XLSX.utils.json_to_sheet(dados, { header: colunas });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "FILTRADO");

    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    XLSX.writeFile(wb, `relatorio_filtrado_${stamp}.xlsx`);
  }

  function aplicarFiltro(){
    const texto = document.getElementById("filtro").value.trim().toUpperCase();
    const termos = texto.split(/\s+/).filter(Boolean);

    const fRom = document.getElementById("fRomaneio").value; // STATUS preenchido/vazio
    const fProg = document.getElementById("fProg").value;     // PROG FAB preenchido/vazio

    const filtrado = cache.filter(row => {
      // Texto (AND)
      if (termos.length){
        const s = [
          row["SERVIÇO"],
          row["LOCAL FABRICAÇÃO"],
          row["MATERIAL"],
          row["PROG FAB"],
          row["STATUS"]
        ].join(" ").toUpperCase();

        if (!termos.every(t => s.includes(t))) return false;
      }

      // Romaneio: STATUS preenchido?
      const temRomaneio = colunaPreenchida(row, "STATUS");
      if (fRom === "COM" && !temRomaneio) return false;
      if (fRom === "SEM" && temRomaneio) return false;

      // Programação: PROG FAB preenchido?
      const temProg = colunaPreenchida(row, "PROG FAB");
      if (fProg === "COM" && !temProg) return false;
      if (fProg === "SEM" && temProg) return false;

      return true;
    });

    ultimoFiltrado = filtrado;

    const tot = renderDetalhado(filtrado);
    renderResumoStatus(filtrado, tot.totalQtd, tot.totalPeso);
    atualizarPizza(filtrado);
  }

  function debounceFiltro(){
    clearTimeout(timerFiltro);
    timerFiltro = setTimeout(aplicarFiltro, 150);
  }

  async function carregar(){
    setStatus("Atualizando...");
    try{
      const r = await fetch(URL, { cache:"no-store" });
      if(!r.ok){
        setStatus("Erro ao carregar (" + r.status + ")");
        return;
      }
      const data = await r.json();
      cache = Array.isArray(data) ? data : [];

      aplicarFiltro();
      setStatus("Atualizado em " + new Date().toLocaleString("pt-BR"));
    }catch(err){
      console.error(err);
      setStatus("Falha de rede / planilha sem acesso público.");
    }
  }

  // Eventos
  document.getElementById("btn").addEventListener("click", carregar);
  document.getElementById("filtro").addEventListener("input", debounceFiltro);

  document.getElementById("fRomaneio").addEventListener("change", aplicarFiltro);
  document.getElementById("fProg").addEventListener("change", aplicarFiltro);

  document.getElementById("btnExport").addEventListener("click", exportarExcelFiltrado);

  document.getElementById("btnPizza").addEventListener("click", () => {
    pizzaModo = (pizzaModo === "PESO") ? "QTD" : "PESO";
    document.getElementById("btnPizza").textContent = pizzaModo === "PESO" ? "Pizza: Peso" : "Pizza: Qtd";
    atualizarPizza(ultimoFiltrado);
  });

  carregar();
</script>

</body>
</html>
